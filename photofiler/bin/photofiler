#!/usr/bin/perl

use XML::Mini;
use XML::Mini::Document;

# check if process is already running
my $pidof = `pidof photofiler`;
chomp($pidof);
my @pids = split / /, $pidof;

for my $pid (@pids) {
    if ($pid != $$) {
        print "Process is already running!";
        exit 1;
    }
}

$config_file = '/etc/photofiler/config.xml';
$log_file = '/var/log/photofiler.log';

# create a new object
my $xml = XML::Mini::Document->new();

# init the doc from an XML string
$xml->fromFile($config_file);

my $source_dir = $xml->getElementByPath('photofiler/source_dir');
my $target_dir = $xml->getElementByPath('photofiler/target_dir');
my $exif_pattern = $xml->getElementByPath('photofiler/exif_pattern');

open(FH, '>', $log_file) or die $!;

my $date = `date`;
chomp($date);

my $source_dir_val = '/mnt/HD/HD_a2/' . $source_dir->text();
my $target_dir_val = '/mnt/HD/HD_a2/' . $target_dir->text();
my $exif_pattern_val = $exif_pattern->text();
my $cmd = "exiftool -overwrite_original -P -r -d $target_dir_val/$exif_pattern_val \"-filename<CreateDate\" $source_dir_val";

print FH "[" . $date . "] Execute exiftool:\n";
print FH "  Source directory: " . $source_dir_val . "\n";
print FH "  Target directory: " . $target_dir_val . "\n";
print FH "  Exif pattern:     " . $exif_pattern_val . "\n";
print FH "  Output exiftool:\n";
print FH `$cmd`;

close(FH);